# Registry with Delete Operation Example
# Demonstrates delete operation - tracks active senders
# When address sends tokens: added to registry
# When address receives tokens: removed from registry
name: RegistryDeleteExample
description: Test delete operations with a registry pattern
repository: https://github.com/joshstevens19/rindexer
project_type: no-code

networks:
  - name: ethereum
    chain_id: 1
    rpc: https://mainnet.gateway.tenderly.co

storage:
  postgres:
    enabled: true
    drop_each_run: true

contracts:
  - name: USDC
    details:
      - network: ethereum
        address: "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48"
        start_block: "18600000"
        end_block: "18600500"  # ~500 blocks for testing
    abi: ./abis/ERC20.abi.json
    tables:
      # Registry of "active senders"
      # Anyone who sends tokens gets added
      # Anyone who receives tokens gets deleted (contrived test case)
      - name: active_senders
        columns:
          - name: address
          - name: last_sent_amount
            default: "0"
          - name: send_count
            type: uint64
            default: "0"
        events:
          - event: Transfer
            operations:
              # Add/update sender in registry when they send tokens
              - type: upsert
                where:
                  address: $from
                if: "$from != 0x0000000000000000000000000000000000000000"
                set:
                  - column: last_sent_amount
                    action: set
                    value: $value
                  - column: send_count
                    action: increment

              # Remove from registry when they receive tokens (tests delete)
              - type: delete
                where:
                  address: $to
                if: "$to != 0x0000000000000000000000000000000000000000"
